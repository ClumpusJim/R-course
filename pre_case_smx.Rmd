---
# Length based indices via mar
---
```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Preamble
___

This case example demonstrates how to calculate standardized survey indices from SMB using the tidyverse approach.

In principle the method is described in [Fjölrit 131](https://www.hafogvatn.is/static/research/files/fjolrit-131pdf). The pseudocode is something like:
```
1.  get survey stations %>%
2.  get length data %>%
3.  get count data %>% 
4.  scale by counted %>% 
5.  trim towlength %>%                  # narrow extremes
6.  standardize by towlength %>%        # on the number only
7.  calculate_biomass %>%               # up to now one recort per length class
8.  summarise by station %>%            # one record per station
9.  filter stations                     # fixed, e.g. tognumer %in% 1:39
10. summarise by strata %>%             # one record per strata
11. raise to strata area %>%            # 
12. summarise by year                   # one record per year
```

# Setup
___

```{r}
library(tidyverse)
library(mar)
con <- connect_mar()
```


## Additonal tables in mar

In order to calculate standardized survey indices we need in addition to the tables in mar information on:

* Length-weight coefficients
* What strata each tow belongs to
* The area of the stratas

For this case example these tables have been made available to all:
```{r}
glimpse(tbl_mar(con, "ops$einarhj.lwcoeff"))
glimpse(tbl_mar(con, "ops$einarhj.smbstationsstrata"))
glimpse(tbl_mar(con, "ops$einarhj.oldstrataarea"))
```

The smbstationsstrata just matches synis_id (tow) with a particular stratanumber. The oldstrataarea contains the area (in km2) for each strata.

## Select a species

Lets select a species to work with and the length above which we want to obtain
the standardized survey indices:
```{r}
Species <- 3                       # Select a species
Length.min <- 5                    # Minimum length for indices calculation
Length.max <- 500                  # Maximum length for indices calculation
```

Some constants used in the standarization process:
```{r}
std.cv        <- 1             # The cv if only one station in a strata
std.towlength <- 4             # Standard tow length is 4 nautical miles
std.width     <- 17            # Standard sweep width in meters
# Standard area swept, units of square nautical miles
#   (1852 meters / nm)
std.area <- std.towlength * std.width / 1852

min.towlength <- 2             # Minimum "acceptable" towlength
max.towlength <- 8             # Maximum "acceptable" towlength
```

A little helper function:
```{r}
#' Calculate overall cv from stratfied summary statistics
#' 
#' @param m Mean value within strata
#' @param s Standard deviation within strata
#' @param area The area (e.g. survey strata area)
#' @param n number of samples within strata
#'
#' @export
#'
calc_cv <- function(m, s, area, n) {
  
  Mean = sum(m * area) / sum(area)
  Sum = sum(m * area)
  tmpsum = sum(m[!is.na(s)] * area[!is.na(s)])
  Calc.sdev = sqrt(sum(s[!is.na(s)]^2 * area[!is.na(s)]^2/  n[!is.na(s)])   / sum(area[!is.na(s)])^2)
  Sdev = Calc.sdev * Sum/tmpsum
  cv = Sdev/Mean
  
  return(cv)
}
```

# The code
___

```{r}
d <-  
  # 1. get survey stations -----------------------------------------------------
  lesa_stodvar(con) %>% 
  filter(synaflokkur == 30, veidarfaeri == 73) %>% 
  select(synis_id, ar, toglengd, reitur, tognumer) %>% 
  
  # 2. get length data ---------------------------------------------------------
  left_join(lesa_lengdir(con) %>% 
              filter(tegund %in% Species,
                     lengd >= Length.min,
                     lengd < Length.max) %>% 
              group_by(synis_id, tegund, lengd) %>% 
              summarise(fjoldi = sum(fjoldi, na.rm = TRUE)) %>% 
              ungroup()) %>% 
  
  # 3. get count data ----------------------------------------------------------
  left_join(lesa_numer(con) %>% 
              mutate(r =  ifelse(fj_maelt != 0, 1 + fj_talid/fj_maelt, 1)) %>% 
              select(synis_id, tegund, r)) %>% 
  
  # 0. A temporary fix, for zero stations --------------------------------------
  #     TODO: Find a more permanent solution so scripts works for more than
  #           one species
  mutate(tegund = if_else(is.na(tegund), Species, tegund),
         lengd  = if_else(is.na(tegund), Length.min, lengd),
         fjoldi = if_else(is.na(tegund), 0, fjoldi),
         r      = if_else(is.na(tegund), 1, r)) %>% 
  
  # 4. scale by counted --------------------------------------------------------
  mutate(N = r * fjoldi / 1e3) %>%   # units of thousand
  
  # 5. trim towlength ----------------------------------------------------------
  mutate(toglengd = if_else(toglengd > max.towlength, max.towlength, toglengd),
         toglengd = if_else(toglengd < min.towlength, min.towlength, toglengd)) %>% 
  
  # 6. standardize by towlength ------------------------------------------------
  mutate(N = N * std.towlength/toglengd)  %>% # standardize to per 4 miles
  
  # 7. calculate_biomass from numbers, length and a and b ----------------------
  # 7.a get the length weight coefficients
  left_join(tbl_mar(con, "ops$einarhj.lwcoeff")) %>% 
  # 7.b use Newton's law if lwcoefficient for species not specified
  mutate(a = ifelse(is.na(a), 0.01, a),
         b = ifelse(is.na(b), 3.00, b),
         B  = ifelse(is.na(N), 0, N) * a * lengd^b/1e3) %>% 
  
  # 8. summarise by station ----------------------------------------------------
  group_by(synis_id, tognumer, ar) %>% 
  summarise(N = sum(N, na.rm = TRUE),
            B = sum(B, na.rm = TRUE)) %>% 
  # Zero stations
  mutate(N = ifelse(is.na(N), 0, N),
         B = ifelse(is.na(B), 0, B)) %>% 
  
  # 9. filter stations ---------------------------------------------------------  
  filter(tognumer %in% 1:39 | is.na(tognumer)) %>%
  
  # 10. summarise by strata ----------------------------------------------------
  # 10.a  Get the strata for each station
  left_join(tbl_mar(con, "ops$einarhj.smbstationsstrata") %>% 
              select(synis_id, strata = oldstrata)) %>% 
  # 10.b group by year and strata and calculate number of stations, mean and sd
  group_by(ar, strata) %>% 
  summarise(sN  = n(),   # number of stations within strata
            n_m  = mean(N, na.rm = TRUE),
            n_d  = ifelse(n() == 1, mean(N, na.rm = TRUE) * std.cv, sd(N)),
            b_m  = mean(B, na.rm = TRUE),
            b_d  = ifelse(n() == 1, mean(B, na.rm = TRUE) * std.cv, sd(B))) %>% 
  
  # 11. raise to strata area ---------------------------------------------------
  # 11.a get area of the strata
  left_join(tbl_mar(con, "ops$einarhj.oldstrataarea") %>% 
              select(strata = oldstrata, area = rall.area)) %>% 
  # 11.b do the strata raising
  #  area is above is in km2, here convert nm2
  mutate(area  = area/1.852^2 / std.area) %>% 
  mutate(n     = n_m  * area,
         b     = b_m  * area) %>% 
  
  # ----------------------------------------------------------------------------
  # Have to collect here because of calc_cv function in the year aggregate step
  # TODO: Fix that, do internally in Oracle
  collect(n = Inf) %>% 
  
  # 11. summarise by year ------------------------------------------------------
  group_by(ar) %>%
  summarise(n = sum(n, na.rm = TRUE),
            # A la Höski
            n.cv = calc_cv(n_m, n_d, area, sN),
            b = sum(b, na.rm = TRUE),
            # A la Höski
            b.cv = calc_cv(b_m, b_d, area, sN)) %>% 
  ungroup()
```


# The results
___

```{r}
glimpse(d)
```

So we have a dataframe where each row is year and then the abundance and biomass indices and the cv. Lets plot the biomass indices:
```{r}
d %>% 
  ggplot(aes(ar, b)) +
  geom_pointrange(aes(ymin = b * (1 - b.cv),
                      ymax = b * (1 + b.cv)),
                  lwd = 1) +
  expand_limits(y = 0) +
  labs(x = NULL, y = NULL,
       title = "Spring survey biomass indices")
```

# Double check

Below we make a comparison with calculation made by Pope Husky, just as a double check

```{r, echo = FALSE}
attach("/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Allaggroldsmbindex.rdata")
vatican <-
 Allaggroldsmbindex %>%
 filter(species == Species,
        svaedi == "Heild",
        diurnal == 0,
        fixed == 0) %>%
 select(ar, lengd, b = bio.staerri, b.cv = cv.bio.staerri) %>%
 mutate(source = "vatican") %>%
 as_tibble()
vatican <-
  vatican %>% 
  filter(lengd == max(min(lengd), Length.min))
detach("file:/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Allaggroldsmbindex.rdata")

d %>% 
  mutate(source = "tidy",
         ar = ar + 0.2) %>% 
  bind_rows(vatican) %>% 
  ggplot(aes(ar, b)) +
  geom_pointrange(aes(ymin = b * (1 - b.cv),
                      ymax = b * (1 + b.cv),
                      colour = source),
                  lwd = 1) +
  scale_colour_brewer(palette = "Set1") +
  theme(legend.position = c(0.1, 0.8)) +
  labs(x = NULL, y = NULL,
       title = "Biomass indices",
       subtitle = "Comparison of the official (vatican) and tidy")
```

# Appendix

Code used to generate the additional tables in mar:

```{r, eval = FALSE}
attach("/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Stations.rdata")
d <- 
  STODVAR.all %>%
  select(synis_id = synis.id, oldstrata, newstrata)
dbWriteTable(con, name = "SMBSTATIONSSTRATA", value = d, overwrite = TRUE)
detach("file:/net/hafkaldi/export/u2/reikn/R/SurveyWork/SMB/Stations.rdata")
# sql("grant select on smbstationsstrata to h_fiskar_skoda")

attach("/net/hafkaldi/export/u2/reikn/R/SurveyWork/OldStratas/.RData")
d <- 
  data_frame(oldstrata = attributes(STRATAS)$names %>% as.integer(),
             area = attributes(STRATAS)$area,
             rall.area = attributes(STRATAS)$rall.area)
dbWriteTable(con, name = "OLDSTRATAAREA", value = d, overwrite = TRUE)
detach("file:/net/hafkaldi/export/u2/reikn/R/SurveyWork/OldStratas/.RData")
# sql("grant select on oldstrataarea to h_fiskar_skoda"
```

